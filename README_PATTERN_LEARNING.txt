===============================================================================
CEO照片模式学习 - 完整工作流程
===============================================================================

概述：
通过标注20个样本，自动学习CEO照片的提取规律，生成优化的提取规则。

===============================================================================
步骤1：准备标注数据
===============================================================================

1.1 创建待标注列表模板：
    python scrapephoto/label_ceo_photos.py

1.2 编辑 samples_to_label.json，填入20个样本：
    [
        {
            "company": "Apple Inc.",
            "cik": "0000320193",
            "fyear": 2023,
            "html_file": "D:/sec_data/apple_inc_0000320193/DEF_14A/xxx/primary-document.html"
        },
        ...（添加20个）
    ]

提示：选择多样化的样本
- 不同行业
- 不同年份
- 不同公司规模
- 确保HTML文件存在且包含CEO照片

===============================================================================
步骤2：交互式标注
===============================================================================

2.1 运行标注工具：
    python scrapephoto/label_ceo_photos.py samples_to_label.json ceo_photo_training_data.json

2.2 标注过程：
    - 工具会显示每个HTML中的所有图片
    - 你输入CEO照片的编号（从0开始）
    - 可以添加备注
    - 输入 's' 跳过当前样本
    - Ctrl+C 随时退出（进度会保存）

2.3 输出：
    ceo_photo_training_data.json - 标注好的训练数据

===============================================================================
步骤3：学习模式
===============================================================================

3.1 运行模式学习：
    python scrapephoto/ceo_photo_pattern_learner.py ceo_photo_training_data.json

3.2 输出结果：
    pattern_learning_results/
    ├── extracted_features.json      # 提取的所有特征
    ├── learned_patterns.json        # 学到的规律
    └── extraction_rules.py          # 生成的提取规则代码

===============================================================================
步骤4：查看学习结果
===============================================================================

4.1 查看规律摘要（会打印在控制台）：

    位置规律：CEO照片通常在第 2-8 张图片
    平均位置：第 4.3 张
    
    尺寸规律：宽度 200-400px, 高度 250-500px
    
    常见父容器标签：
      div: 15次
      td: 8次
      section: 3次
    
    SHAREHOLDERS 关键词距离：500-3000 字符
      平均距离：1200 字符
      命中率：18/20

4.2 详细分析：
    查看 learned_patterns.json 了解：
    - 位置分布统计
    - 尺寸范围
    - 容器模式（常见的class、id）
    - 关键词距离统计
    - DOM路径模式

===============================================================================
步骤5：应用学到的规则
===============================================================================

5.1 手动应用：
    根据 extraction_rules.py 中的规则，修改 ceo_photo_pipeline_test.py：
    
    - 调整位置过滤范围
    - 调整尺寸阈值
    - 添加容器class/id匹配
    - 优化关键词距离判断

5.2 自动应用（高级）：
    可以编写代码读取 learned_patterns.json，动态调整提取参数

===============================================================================
提取的特征说明
===============================================================================

每个样本会提取以下特征：

1. 图片位置特征
   - image_position: 第几张图片
   - total_images: 总图片数

2. 图片属性特征
   - image_size: (width, height)
   - has_width_height: 是否有尺寸属性

3. 容器特征（向上5层）
   - parent_N_tag: 父容器标签名
   - parent_N_class: 父容器class
   - parent_N_id: 父容器id
   - parent_N_has_shareholders: 是否包含shareholders
   - parent_N_has_sincerely: 是否包含sincerely
   - parent_N_text_length: 文本长度
   - parent_N_img_count: 包含的图片数

4. 关键词邻近特征
   - nearest_shareholders_distance: 到shareholders的距离
   - nearest_sincerely_distance: 到sincerely的距离
   - nearest_ceo_distance: 到ceo的距离

5. DOM路径特征
   - dom_path: 简化的DOM路径

===============================================================================
学到的规律示例
===============================================================================

典型发现：

1. 位置规律
   ✓ 80% CEO照片在第2-6张图片
   ✓ 不在第0张（封面）

2. 尺寸规律
   ✓ 宽度通常 200-500px
   ✓ 高度通常 250-600px
   ✓ 宽高比 0.6-1.2

3. 容器规律
   ✓ 父容器常见：div (70%), td (20%), section (10%)
   ✓ 常见class：signature, ceo-message, letter
   ✓ 容器通常同时包含 "shareholders" 和 "sincerely"

4. 关键词距离
   ✓ 距离 "sincerely" 平均 800 字符
   ✓ 距离 "to our shareholders" 平均 1500 字符
   ✓ 85% 在关键词 2000 字符范围内

5. DOM路径
   ✓ 常见路径模式：
     body > div.main > div.ceo-letter > img
     body > table > tr > td > img

===============================================================================
优化建议
===============================================================================

根据学到的规律，可以这样优化 find_ceo_letter_blocks():

1. 添加位置过滤：
   if img_position < 2 or img_position > 10:
       skip

2. 添加尺寸过滤：
   if not (200 <= width <= 500 and 250 <= height <= 600):
       skip

3. 优先级调整：
   - 如果容器class包含 "signature"/"ceo"/"letter" -> 高优先级
   - 如果在关键词500字符内 -> 高优先级

4. 容器识别增强：
   查找常见的class/id模式（从学习结果中获取）

===============================================================================
持续改进
===============================================================================

1. 增量学习：
   - 定期标注新样本
   - 重新运行学习
   - 对比规律变化

2. A/B测试：
   - 用旧规则和新规则分别提取
   - 对比准确率
   - 选择更好的规则

3. 难样本分析：
   - 找出提取失败的案例
   - 添加到训练集
   - 针对性改进

===============================================================================

